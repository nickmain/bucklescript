<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<meta name="author" content="Hongbo Zhang">
<title>BuckleScript User Manual</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<style>
/* Pygments styles disabled. Pygments is not available. */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1><a href="https://github.com/bloomberg/bucklescript">BuckleScript</a> User Manual</h1>
<div class="details">
<span id="author" class="author">Hongbo Zhang</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_why_bucklescript">Why BuckleScript</a>
<ul class="sectlevel2">
<li><a href="#_benefits_of_javascript_platform">Benefits of JavaScript platform</a></li>
<li><a href="#_problems_of_javascript_how_bucklescript_solves_it">Problems of JavaScript &amp;&amp; how BuckleScript solves it</a></li>
</ul>
</li>
<li><a href="#_installation">Installation</a>
<ul class="sectlevel2">
<li><a href="#_install_from_npm_registries">Install from NPM registries</a></li>
<li><a href="#_install_from_source_with_npm_package_manager">Install from source with npm package manager</a></li>
<li><a href="#_install_with_em_minimal_em_dependencies">Install with <em>minimal</em> dependencies</a></li>
<li><a href="#_introduction_to_ocaml_ecosystem_opam">Introduction to OCaml ecosystem: OPAM</a></li>
</ul>
</li>
<li><a href="#_get_started">Get Started</a>
<ul class="sectlevel2">
<li><a href="#_first_example">First example</a></li>
<li><a href="#_an_example_with_multiple_modules">An example with multiple modules</a></li>
</ul>
</li>
<li><a href="#_built_in_npm_support">Built in npm support</a>
<ul class="sectlevel2">
<li><a href="#_build_ocaml_library_as_a_npm_package">Build OCaml library as a npm package</a></li>
<li><a href="#_to_use_ocaml_library_as_a_npm_package">To use OCaml library as a npm package</a></li>
<li><a href="#_together">Together</a></li>
<li><a href="#_examples">Examples</a></li>
</ul>
</li>
<li><a href="#_js_calling_ocaml">JS Calling OCaml</a></li>
<li><a href="#_ocaml_calling_js">OCaml calling JS</a>
<ul class="sectlevel2">
<li><a href="#_binding_to_simple_js_functions_values">Binding to simple JS functions values</a>
<ul class="sectlevel3">
<li><a href="#_binding_to_global_value_bs_val">Binding to global value: bs.val</a></li>
<li><a href="#_binding_to_javascript_constructor_bs_new">Binding to JavaScript constructor: bs.new</a></li>
<li><a href="#_binding_to_a_value_from_a_module_bs_module">Binding to a value from a module: bs.module</a></li>
<li><a href="#_binding_the_whole_module_as_a_value_or_function">Binding the whole module as a value or function</a></li>
<li><a href="#_binding_to_method_bs_send_bs_send_pipe">Binding to method: bs.send, bs.send.pipe</a></li>
<li><a href="#_binding_to_dynamic_key_access_set_bs_set_index_bs_get_index">Binding to dynamic key access/set: bs.set_index, bs.get_index</a></li>
<li><a href="#_binding_to_getter_setter_bs_get_bs_set">Binding to Getter/Setter: bs.get, bs.set</a></li>
</ul>
</li>
<li><a href="#_special_types_on_external_declarations_bs_string_bs_int_bs_ignore">Special types on external declarations: bs.string, bs.int, bs.ignore</a>
<ul class="sectlevel3">
<li><a href="#_using_polymorphic_variant_to_model_enums_and_string_types">Using polymorphic variant to model enums and string types</a></li>
<li><a href="#_using_polymorphic_variant_to_model_event_listener">Using polymorphic variant to model event listener</a></li>
<li><a href="#_phantom_arguments_and_ad_hoc_polyrmophism">Phantom Arguments and ad-hoc polyrmophism</a></li>
</ul>
</li>
<li><a href="#_binding_to_nodejs_special_variables_bs_node">Binding to NodeJS special variables: bs.node</a></li>
<li><a href="#_binding_to_callbacks_high_order_function">Binding to callbacks (high-order function)</a>
<ul class="sectlevel3">
<li><a href="#_uncurried_calling_convention_as_an_optimization">Uncurried calling convention as an optimization</a>
<ul class="sectlevel4">
<li><a href="#_callback_optimization">Callback optimization</a></li>
</ul>
</li>
<li><a href="#_bindings_to_code_this_code_based_callbacks_bs_this">Bindings to <code>this</code> based callbacks: bs.this</a></li>
</ul>
</li>
<li><a href="#_binding_to_js_objects">Binding to JS objects</a>
<ul class="sectlevel3">
<li><a href="#_simple_object_type">Simple object type</a></li>
<li><a href="#_complex_object_type">Complex object type</a></li>
<li><a href="#_how_to_consume_js_property_and_methods">How to consume JS property and methods</a>
<ul class="sectlevel4">
<li><a href="#_getter_setter_annotation_to_js_properties">getter/setter annotation to JS properties</a></li>
</ul>
</li>
<li><a href="#_create_js_objects_using_bs_obj">Create JS objects using bs.obj</a></li>
<li><a href="#_create_js_objects_using_external">Create JS objects using external</a></li>
<li><a href="#_create_js_objects_with_code_this_code_semantics">Create JS objects with <code>this</code> semantics</a>
<ul class="sectlevel4">
<li><a href="#_method_chaining">Method chaining</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_embedding_raw_javascript_code">Embedding raw Javascript code</a>
<ul class="sectlevel3">
<li><a href="#_embedding_raw_js_code_as_an_expression">Embedding raw JS code as an expression</a></li>
<li><a href="#_embedding_raw_js_code_as_statements">Embedding raw JS code as statements</a></li>
</ul>
</li>
<li><a href="#_debugger_support">Debugger support</a></li>
<li><a href="#_regex_support">Regex support</a></li>
<li><a href="#_examples_2">Examples</a>
<ul class="sectlevel3">
<li><a href="#_a_simple_example_binding_to_mocha_unit_test_library">A simple example: binding to mocha unit test library</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_js_module">Js module</a></li>
<li><a href="#_extended_compiler_options">Extended compiler options</a>
<ul class="sectlevel2">
<li><a href="#__bs_main_single_directory_build">-bs-main (single directory build)</a></li>
<li><a href="#__bs_files">-bs-files</a></li>
<li><a href="#__bs_package_name">-bs-package-name</a></li>
<li><a href="#__bs_packge_output">-bs-packge-output</a></li>
<li><a href="#__bs_gen_tds">-bs-gen-tds</a></li>
<li><a href="#__bs_no_builtin_ppx_ml_bs_no_builtin_ppx_mli">-bs-no-builtin-ppx-ml, -bs-no-builtin-ppx-mli</a></li>
</ul>
</li>
<li><a href="#_semantics_difference_from_other_backends">Semantics difference from other backends</a>
<ul class="sectlevel2">
<li><a href="#_custom_data_type">Custom data type</a></li>
<li><a href="#_physical_in_equality">Physical (in)equality</a></li>
<li><a href="#_string_char_range">String char range</a></li>
<li><a href="#_weak_map">Weak map</a></li>
<li><a href="#_integers">Integers</a></li>
<li><a href="#_printf_printf">Printf.printf</a></li>
<li><a href="#_hashtbl_hash_algorithm">Hashtbl hash algorithm</a></li>
<li><a href="#_marshall">Marshall</a></li>
<li><a href="#_sys_argv">Sys.argv</a></li>
<li><a href="#_unsupported_io_primitives">Unsupported IO primitives</a></li>
</ul>
</li>
<li><a href="#_faq">FAQ</a></li>
<li><a href="#_high_level_compiler_workflow">High Level compiler workflow</a>
<ul class="sectlevel2">
<li><a href="#_design_principles">Design Principles</a></li>
<li><a href="#_soundness">Soundness</a></li>
<li><a href="#_minimal_new_symbol_creation">Minimal new symbol creation</a></li>
</ul>
</li>
<li><a href="#_runtime_representation">Runtime representation</a>
<ul class="sectlevel2">
<li><a href="#_simple_ocaml_type">Simple OCaml type</a></li>
</ul>
</li>
<li><a href="#_integration_with_reason">Integration with Reason</a></li>
<li><a href="#_how_to_contribute">How to contribute</a>
<ul class="sectlevel2">
<li><a href="#_build_the_compiler">Build the compiler</a></li>
<li><a href="#_build_the_runtime">Build the runtime</a></li>
<li><a href="#_build_the_stdlib">Build the stdlib</a></li>
<li><a href="#_help_rewrite_the_whole_runtime_in_ocaml">Help rewrite the whole runtime in OCaml</a></li>
</ul>
</li>
<li><a href="#_comparisons">Comparisons</a>
<ul class="sectlevel2">
<li><a href="#_difference_from_a_href_https_github_com_ocsigen_js_of_ocaml_js_of_ocaml_a">Difference from <a href="https://github.com/ocsigen/js_of_ocaml">js_of_ocaml</a></a></li>
</ul>
</li>
<li><a href="#_changes">Appendix A: CHANGES</a></li>
<li><a href="#_1_02_dev">1.02 (dev)</a></li>
<li><a href="#_1_01">1.01</a></li>
<li><a href="#_1_0">1.0</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>BuckleScript is a backend for the <a href="https://ocaml.org/">OCaml</a> compiler which emits
JavaScript. It works with both vanilla OCaml and <a href="https://github.com/facebook/Reason">Reason</a>, the
whole compiler is compiled into JS (and ASM) so that you can play it
in the <a href="http://bloomberg.github.io/bucklescript/js-demo/">browser</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Document under <a href="http://bloomberg.github.io/bucklescript/Manual.html"><em>bloomberg.github.io</em></a> matches with <a href="https://github.com/bloomberg/bucklescript">master branch</a>.</div>
<div class="paragraph">
<p>They are also  distributed as a single HTML(<code>docs/Manual.html</code>) together with your <a href="#_installation">Installation</a> (with the exact version).
If you find errors or omissions in this document, please don&#8217;t
hesitate to submit an issue, sources are <a href="https://github.com/bloomberg/bucklescript/tree/master/site/docsource">here</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_bucklescript"><a class="anchor" href="#_why_bucklescript"></a>Why BuckleScript</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_benefits_of_javascript_platform"><a class="anchor" href="#_benefits_of_javascript_platform"></a>Benefits of JavaScript platform</h3>
<div class="paragraph">
<p>JavaScript is not just <em>the</em> browser language, it&#8217;s also the <em>only</em>
existing cross platform language. It is truly everywhere: users don&#8217;t
need to install binaries or use package managers to access software,
just a link will work.</p>
</div>
<div class="paragraph">
<p>Another important factor is that the JavaScript VM is quite fast and
keeps getting faster.  The JavaScript platform is therefore
increasingly capable of supporting large applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="_problems_of_javascript_how_bucklescript_solves_it"><a class="anchor" href="#_problems_of_javascript_how_bucklescript_solves_it"></a>Problems of JavaScript &amp;&amp; how BuckleScript solves it</h3>
<div class="paragraph">
<p>BuckleScript is mainly designed to solve the problems of <em>large scale</em> JavaScript programming:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Type-safety</dt>
<dd>
<p>OCaml offers an industrial-strength
state-of-the-art type system and provides very strong type inference (i.e. No
verbose type annotation required compared with typescript), which proves
<a href="http://programmers.stackexchange.com/questions/215482/what-are-the-safety-benefits-of-a-type-system">invaluable</a>
in managing large projects. OCaml&#8217;s type system is not just for tooling,
it is a <em>sound</em> type system which means it is guaranteed that there will
be no runtime type errors after type checking.</p>
</dd>
<dt class="hdlist1">High quality dead code elimination</dt>
<dd>
<p>A large amount of web-development relies on inclusion of
  code dependencies by copying or referencing CDNs (the very thing
  that makes JavaScript highly accessible), but this also introduces
  a lot of <a href="https://en.wikipedia.org/wiki/Dead_code">dead code</a>. This
  impacts performance adversely when the JavaScript VM has to
  interpret code that will never be invoked. BuckleScript provides
  powerful dead-code elimination at all levels:</p>
<div class="ulist">
<ul>
<li>
<p>Function and module level elimination is facilitated by the
sophistication of the type-system of OCaml and <em>purity analysis</em>.</p>
</li>
<li>
<p>At the global level BuckleScript generates code ready for
dead-code elimination done by bundling tools such as the
<a href="https://developers.google.com/closure/compiler/">Google closure-compiler</a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Offline optimizations</dt>
<dd>
<p>JavaScript is a dynamic language, it
takes a performance-hit for the VM to optimize code at runtime.
While some JS engines circumvent the problem to some extent by
<a href="http://v8project.blogspot.com/2015/07/code-caching.html">caching</a>,
this is not available to all environments, and lack of a strong
type system also limits the level of optimizations possible. Again,
BuckleScript, using features of the OCaml type-system and compiler
implementation is able to provide many optimizations during offline
compilation, allowing the runtime code to be extremely fast.</p>
</dd>
<dt class="hdlist1">JS platform and Native platform</dt>
<dd>
<p>Run your programs on all platforms, but run your system <em>faster</em>
under specific platforms. Javascript is everywhere but it does not
mean we have to run all apps in JS, under several platforms, for
example, server side or iOS/Android native apps, when programs are
written in OCaml, it can also be compiled to native code for <em>better
and reliable performance</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>While a strong type-system helps in countering these problems, at the
same time we hope to avoid some of the problems faced in using other
offline <a href="https://github.com/jashkenas/coffeescript/wiki/list-of-languages-that-compile-to-js">transpilation systems</a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Slow compilation</dt>
<dd>
<p>OCaml byte-code compilation is known to be fast
  (one or two orders of magnitude faster than other similar languages:
<a href="http://www.scala-lang.org/">Scala</a> or
  <a href="https://www.haskell.org/">Haskell</a>),
  BuckleScript shares the same property and compiles even faster
  since it saves the link time. See the speeds at work in the
  <a href="http://bloomberg.github.io/bucklescript/js-demo/">playground</a>, the native backend is one
  order faster than the JS backend.</p>
</dd>
<dt class="hdlist1">Un-readable JS Code and hard to integrate with existing JS  libraries</dt>
<dd>
<p>When compiling to JavaScript, many systems
  generate code, that while syntactically and semantically correct is
  not human-readable and very difficult to debug and profile.
  Our BuckleScript implementation and the multi-pass compilation  strategy of OCaml,
  allows us to avoid <a href="https://en.wikipedia.org/wiki/Name_mangling">name-mangling</a>,
  and produce JavaScript code that is human-readable and easier to debug and
  maintain. More importantly, this makes integration with existing JS
  libraries <em>much easier</em>.</p>
</dd>
<dt class="hdlist1">Large JS output even for a simple program</dt>
<dd>
<p>In BuckleScript, a <code>Hello world</code> program generates <em>20 bytes</em> JS code
instead of <em>50K bytes</em>. This is due to that BuckleScript has an excellent
integration with JS libs that unlike most JS compilers,
all BuckleScript&#8217;s runtime is written in OCaml itself so that these
runtime libraries are only needed when user actually call it.</p>
</dd>
<dt class="hdlist1">Loss of code-structure</dt>
<dd>
<p>Many systems generate JavaScript code that is essentially a
 <a href="https://en.wikipedia.org/wiki/Big_ball_of_mud">big ball of mud</a>. We try
 to keep the original structure of the code by mapping one OCaml module
 to one JS module.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation"><a class="anchor" href="#_installation"></a>Installation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_install_from_npm_registries"><a class="anchor" href="#_install_from_npm_registries"></a>Install from NPM registries</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Standard C toolchain</p>
</li>
<li>
<p><code>npm</code> (should be installed with Node)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The standard <code>npm</code> package management tool can be used to install
BuckleScript. If you don&#8217;t already have <code>npm</code> installed, follow the
directions listed
<a href="https://docs.npmjs.com/getting-started/installing-node">here</a>. Once <code>npm</code>
is installed, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">npm install --save bs-platform</code></pre>
</div>
</div>
<div class="paragraph">
<p>or install it globally</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shh">npm install -g bs-platform</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_install_from_source_with_npm_package_manager"><a class="anchor" href="#_install_from_source_with_npm_package_manager"></a>Install from source with npm package manager</h3>
<div class="olist arabic">
<div class="title">Prerequisites:</div>
<ol class="arabic">
<li>
<p>Standard C toolchain</p>
</li>
<li>
<p><code>npm</code> (should be installed with Node)</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Instructions:</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">git clone https://github.com/bloomberg/bucklescript
cd bucklescript
npm install</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_install_with_em_minimal_em_dependencies"><a class="anchor" href="#_install_with_em_minimal_em_dependencies"></a>Install with <em>minimal</em> dependencies</h3>
<div class="olist arabic">
<div class="title">Prerequisites:</div>
<ol class="arabic">
<li>
<p>Standard C toolchain</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>BuckleScript has very few dependencies and building from source can
easily be done.</p>
</div>
<div class="listingblock">
<div class="title">Build OCaml compiler</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">git clone --recursive https://github.com/bloomberg/bucklescript
cd bucklescript/ocaml
./configure -prefix `pwd` # put your preferred directory
make world.opt
make install</code></pre>
</div>
</div>
<div class="paragraph">
<p>The patched compiler is installed locally into your <code>$(pwd)/bin</code>
directory. To start using it temporarily, check if <code>ocamlc.opt</code> and
<code>ocamlopt.opt</code> exist in <code>$(pwd)/bin</code>, and temporarily add the location
to your <code>$(PATH)</code> (e.g.  <code>PATH=$(pwd)/bin:$PATH</code>).</p>
</div>
<div class="paragraph">
<div class="title">Building BuckleScript</div>
<p>The following directions assume you already have the correct version of
<code>ocamlopt.opt</code> in your <code>$PATH</code>, having followed the process described in
the previous section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">export BS_RELEASE_BUILD=1
make world</code></pre>
</div>
</div>
<hr>
<div class="paragraph">
<p>At the end, you should have a binary called <code>bsc</code> under <code>jscomp/bin</code>
directory, which you can add to your <code>$PATH</code>.
You could also set an environment variable
pointing to the stdlib, e.g. <code>BSC_LIB=/path/to/jscomp/stdlib</code> for ease
of use.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The built compiler is not <em>relocatable</em> out of box, please don&#8217;t move it around unless you know what you are doing
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_introduction_to_ocaml_ecosystem_opam"><a class="anchor" href="#_introduction_to_ocaml_ecosystem_opam"></a>Introduction to OCaml ecosystem: OPAM</h3>
<div class="paragraph">
<p>When working with OCaml we also recommend using <a href="https://opam.ocaml.org">opam</a>
package manager to install OCaml tools, available
<a href="https://opam.ocaml.org/doc/Install.html">here</a>. You will benefit from the
existing OCaml ecosystem.</p>
</div>
<div class="paragraph">
<p>Once you have <code>opam</code> installed, ask <code>opam</code> to switch to using our
version of the compiler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">opam update
opam switch 4.02.3
eval `opam config env`</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_started"><a class="anchor" href="#_get_started"></a>Get Started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_first_example"><a class="anchor" href="#_first_example"></a>First example</h3>
<div class="ulist">
<ul>
<li>
<p>Create a directory called <code>hello</code> and create <code>package.json</code>
as below:</p>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js">{
    "dependencies": {
        "bs-platform": "1.0.1" <b class="conum">(1)</b>
    },
    "scripts" : {
        "build" : "bsc -c  main_entry.ml"
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Version should be updated accordingly</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create <code>main_entry.ml</code> as below:</p>
<div class="listingblock">
<div class="title">main_entry.ml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let () =
  print_endline "hello world"</code></pre>
</div>
</div>
</li>
<li>
<p>Build the app</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">npm run build</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now you should see a file called <code>main_entry.js</code> generated as below:</p>
</div>
<div class="listingblock">
<div class="title">main_entry.js</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js">// GENERATED CODE BY BUCKLESCRIPT VERSION 1.0.1 , PLEASE EDIT WITH CARE
'use strict';


console.log("hello world");

/*  Not a pure module */ <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The compiler analyze this module is impure due to the side effect</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The working code is available <a href="https://github.com/bloomberg/bucklescript-addons/tree/master/examples/hello">here</a>:
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_an_example_with_multiple_modules"><a class="anchor" href="#_an_example_with_multiple_modules"></a>An example with multiple modules</h3>
<div class="paragraph">
<p>Now we want to create two modules, one file called <code>fib.ml</code> which
exports <code>fib</code> function, the other module called <code>main_entry.ml</code> which
will call <code>fib</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a directory <code>fib</code> and created a file <code>package.json</code></p>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js">{
    "dependencies": {
        "bs-platform": "1.0.1"
    },
    "scripts" : {
        "build" : "bsc -c -bs-main main_entry.ml" <b class="conum">(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>here <code>-bs-main</code> option tells the compiler compile <code>main_entry</code> module and
its dependency accordingly</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create file <code>fib.ml</code> and file <code>main_entry.ml</code></p>
<div class="listingblock">
<div class="title">fib.ml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let  fib n  =
  let rec aux n a b =
    if n = 0 then a
    else
      aux (n - 1) b (a+b)
  in aux n 1 1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">main_entry.ml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let () =
  for i = 0 to 10 do
    Js.log (Fib.fib i) <b class="conum">(1)</b>
  done</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>Js</code> module is a built-in module shipped with BuckleScript</p>
</li>
</ol>
</div>
</li>
<li>
<p>Build the app</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">npm install
npm run build
node main_entry.js</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If everything goes well, you should see the output as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">1
1
2
3
5
8
13
21
34
55
89</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_built_in_npm_support"><a class="anchor" href="#_built_in_npm_support"></a>Built in npm support</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_build_ocaml_library_as_a_npm_package"><a class="anchor" href="#_build_ocaml_library_as_a_npm_package"></a>Build OCaml library as a npm package</h3>
<div class="paragraph">
<p>BuckleScript extends the OCaml compiler options with several flags to
provide better experience for NPM users.</p>
</div>
<div class="paragraph">
<p>In general, you are expected to deploy two kinds of artifacts, the
generated JS files and meta data which your OCaml dependencies rely
on.</p>
</div>
<div class="paragraph">
<p>Since CommonJS has no namespaces, to allow JS files live in different
directories, we have a flag</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -bs-package-name $npm_package_name -bs-package-output modulesystem:path/to/your/js/dir -c a.ml</code></pre>
</div>
</div>
<div class="paragraph">
<p>By passing this flag, <code>bsc</code> will store your <code>package_name</code> and
relative path to <code>package.json</code> in <code>.cmj</code> files. It will also generate
JS files in the directory you specified. You can, and are encouraged
to, store Javascript files in a hierarchical directory.</p>
</div>
<div class="paragraph">
<p>For the binary artifacts, (Note that this is not necessary if you only
want your libraries to be consumed by JS developers, and it has
benefit since end users don&#8217;t need these binary data any more), the
convention is to store all <code>*.cm</code> data in a <em>single</em> directory
<code>package.json/lib/ocaml</code>
and Javascript files in a <em>hierachical</em> directory like <code>package.json/lib/js</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_to_use_ocaml_library_as_a_npm_package"><a class="anchor" href="#_to_use_ocaml_library_as_a_npm_package"></a>To use OCaml library as a npm package</h3>
<div class="paragraph">
<p>If you follow the layout convention above, using an OCaml package is
pretty straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -bs-package-include ocaml-package-name -c a.ml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_together"><a class="anchor" href="#_together"></a>Together</h3>
<div class="paragraph">
<p>Your command line would be like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -bs-package-include ocaml-package1 -bs-package-include ocaml-package2  -bs-package-name $npm_package_name -bs-package-output commonjs:path/to/lib/js/ -c a.ml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples"><a class="anchor" href="#_examples"></a>Examples</h3>
<div class="paragraph">
<p>Please visit <a href="https://github.com/bloomberg/bucklescript-addons" class="bare">https://github.com/bloomberg/bucklescript-addons</a> for more examples.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_js_calling_ocaml"><a class="anchor" href="#_js_calling_ocaml"></a>JS Calling OCaml</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since BuckleScript guarantees that all OCaml functions are exported as
is, no extra work is required to expose OCaml function to JavaScript.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p><code>external</code> exports are not exported as JS functions, if you really
want to export those external functions, please write <code>val</code> instead</p>
</li>
<li>
<p><code>operators</code> are escaped, since Javascript does not support user
defined operators. For example, instead of calling <code>Pervasives.(^)</code>,
you have to call <code>Pervasives.$caret</code> from your Javascript functions</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If users want to consume some OCaml features only available in OCaml but not in JS,
we recommend users to export it as functions.</p>
</div>
<div class="paragraph">
<p>For example, data constructors are not available in JS</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">  type t =
    | Cons of int * t
    | Nil</code></pre>
</div>
</div>
<div class="paragraph">
<p>Currently, we recommend user to expose the constructor as a function
so that it can be constructed from the JS side.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let cons x y = Cons (x,y)
let nil = Nil</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>In the future, we will derive these functions to
automate such process</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ocaml_calling_js"><a class="anchor" href="#_ocaml_calling_js"></a>OCaml calling JS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To make OCaml work smoothly with Javascript, we introduced several
extensions to the OCaml language. These BuckleScript extensions
facilitate the integration of native JavaScript code and
improve the generated code.</p>
</div>
<div class="paragraph">
<p>Like TypeScript, when building type-safe bindings from JS to OCaml,
users have to write type declarations.
In OCaml, unlike TypeScript, users do not need to create a separate
<code>.d.ts</code> file,
since the type declarations is an integral part of OCaml.</p>
</div>
<div class="paragraph">
<p>The FFI is divided into several components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Binding to simple functions and values</p>
</li>
<li>
<p>Binding to high-order functions</p>
</li>
<li>
<p>Binding to object literals</p>
</li>
<li>
<p>Binding to classes</p>
</li>
<li>
<p>Extensions to the language for debugger, regex and embedding arbitrary JS
code</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_binding_to_simple_js_functions_values"><a class="anchor" href="#_binding_to_simple_js_functions_values"></a>Binding to simple JS functions values</h3>
<div class="paragraph">
<p>This part is similar to <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.02/intfc.html">traditional FFI</a>,
with syntax as described below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external value-name :  typexpr =  external-declaration  attributes
external-declaration :=  string-literal</code></pre>
</div>
</div>
<div class="paragraph">
<p>Users need to declare types for foreign functions
(JS functions for BuckleScript or C functions for native compiler)
and provide customized <code>attributes</code>.</p>
</div>
<div class="sect3">
<h4 id="_binding_to_global_value_bs_val"><a class="anchor" href="#_binding_to_global_value_bs_val"></a>Binding to global value: bs.val</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external imul : int -&gt; int -&gt; int = "Math.imul" [@@bs.val]
type dom
(* Abstract type for the DOM *)
external dom : dom = "document" [@@bs.val]</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bs.val</code> attribute is used to bind to a JavaScript value,
it can be a function or plain value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>If <code>external-declaration</code> is the same as <code>value-name</code>, user can leave <code>external-declaration</code> empty,
for example:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external document : dom = "" [@@bs.val]</code></pre>
</div>
</div>
</li>
<li>
<p>If you want to make a single FFI for both C functions and
JavaScript functions, you can
give the JavaScript foreign function a different name:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external imul : int -&gt; int -&gt; int =
  "c_imul" [@@bs.val "Math.imul"]</code></pre>
</div>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_binding_to_javascript_constructor_bs_new"><a class="anchor" href="#_binding_to_javascript_constructor_bs_new"></a>Binding to JavaScript constructor: bs.new</h4>
<div class="paragraph">
<p><code>bs.new</code> is used to create a JavaScript object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external create_date : unit -&gt; t = "Date" [@@bs.new]
let date = create_date ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var date = new Date();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_binding_to_a_value_from_a_module_bs_module"><a class="anchor" href="#_binding_to_a_value_from_a_module_bs_module"></a>Binding to a value from a module: bs.module</h4>
<div class="paragraph">
<p>Input:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external add : int -&gt; int -&gt; int = "add" [@@bs.module "x"]
external add2 : int -&gt; int -&gt; int = "add2"[@@bs.module "y", "U"] <b class="conum">(1)</b>
let f = add 3 4
let g = add2 3 4</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>"U" will hint the compiler to generate a better name for the module, see output</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var U = require("y");
var X = require("x");
var f = X.add(3, 4);
var g = U.add2(3, 4);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>if <code>external-declaration</code> is the same as value-name, it can be left empty, for example,</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external add : int -&gt; int -&gt; int = "" [@@bs.module "x"]</code></pre>
</div>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_binding_the_whole_module_as_a_value_or_function"><a class="anchor" href="#_binding_the_whole_module_as_a_value_or_function"></a>Binding the whole module as a value or function</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type http
external http : http = "http" [@@bs.module] <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>external-declaration</code> is the module name</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>if <code>external-declaration</code> is the same as value-name, it can be left empty, for example,</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external http : http = "" [@@bs.module]</code></pre>
</div>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_binding_to_method_bs_send_bs_send_pipe"><a class="anchor" href="#_binding_to_method_bs_send_bs_send_pipe"></a>Binding to method: bs.send, bs.send.pipe</h4>
<div class="paragraph">
<p><code>bs.send</code> helps the user send a message to a JS object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type id (** Abstract type for id object *)
external get_by_id : dom -&gt; string -&gt; id =
  "getElementById" [@@bs.send]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The object is always the first argument and actual arguments follow.</p>
</div>
<div class="paragraph">
<p>Input:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">get_by_id dom "xx"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">dom.getElementById("xx")</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bs.pipe.send</code> is similar to <code>bs.send</code> except that the first argument, i.e, the object,
is put in the position of last argument to help user write in a <em>chaining style</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external map : ('a -&gt; 'b [@bs]) -&gt; 'b array =
  "" [@@bs.send.pipe: 'a array] <b class="conum">(1)</b>
external forEach: ('a -&gt; unit [@bs]) -&gt; 'a array =
  "" [@@bs.send.pipe: 'a array]
let test arr =
    arr
    |&gt; map (fun [@bs] x -&gt; x + 1)
    |&gt; forEach (fun [@bs] x -&gt; Js.log x)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>For the <code>[@bs]</code> attribute in the callback, see <a href="#_binding_to_callbacks_high_order_function">Binding to callbacks (high-order function)</a></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>if <code>external-declaration</code> is the same as value-name, it can be left empty, for example,</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external getElementById : dom -&gt; string -&gt; id =
  "" [@@bs.send]</code></pre>
</div>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_binding_to_dynamic_key_access_set_bs_set_index_bs_get_index"><a class="anchor" href="#_binding_to_dynamic_key_access_set_bs_set_index_bs_get_index"></a>Binding to dynamic key access/set: bs.set_index, bs.get_index</h4>
<div class="paragraph">
<p>This attribute allows dynamic access to a JavaScript property</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type t
external create : int -&gt; t = "Int32Array" [@@bs.new]
external get : t -&gt; int -&gt; int = "" [@@bs.get_index]
external set : t -&gt; int -&gt; int -&gt; unit = "" [@@bs.set_index]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_binding_to_getter_setter_bs_get_bs_set"><a class="anchor" href="#_binding_to_getter_setter_bs_get_bs_set"></a>Binding to Getter/Setter: bs.get, bs.set</h4>
<div class="paragraph">
<p>This attribute helps get and set the property of a JavaScript object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type textarea
external set_name : textarea -&gt; string -&gt; unit = "name" [@@bs.set]
external get_name : textarea -&gt; string = "name" [@@bs.get]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_special_types_on_external_declarations_bs_string_bs_int_bs_ignore"><a class="anchor" href="#_special_types_on_external_declarations_bs_string_bs_int_bs_ignore"></a>Special types on external declarations: bs.string, bs.int, bs.ignore</h3>
<div class="sect3">
<h4 id="_using_polymorphic_variant_to_model_enums_and_string_types"><a class="anchor" href="#_using_polymorphic_variant_to_model_enums_and_string_types"></a>Using polymorphic variant to model enums and string types</h4>
<div class="paragraph">
<p>There are several patterns heavily used in existing JavaScript codebase, for example,
string type is used a lot. BuckleScript FFI allows to model string type in a safe
way by using annotated polymorphic variant.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external readFileSync :
  name:string -&gt;
  ([ `utf8
   | `my_name [@bs.as "ascii"] <b class="conum">(1)</b>
   ] [@bs.string]) -&gt;
  string = ""
  [@@bs.module "fs"]

let _ =
  readFileSync ~name:"xx.txt" `my_name</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Here we intentionally made an example to show how to  customize a name</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ouptut:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var Fs = require("fs");
Fs.readFileSync("xx.txt", "ascii");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Polymoprhic variants can also be used to model <em>enums</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external test_int_type :
  ([ `on_closed <b class="conum">(1)</b>
   | `on_open [@bs.as 3]  <b class="conum">(2)</b>
   | `in_bin <b class="conum">(3)</b>
   ]
   [@bs.int])  -&gt; int  =
  "" [@@bs.val]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><em>`on_closed</em> will be encoded as 0</p>
</li>
<li>
<p><em>`on_open</em> will be 3 due to the attribute <code>bs.as</code></p>
</li>
<li>
<p><em>`in_bin</em> will be 4</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_using_polymorphic_variant_to_model_event_listener"><a class="anchor" href="#_using_polymorphic_variant_to_model_event_listener"></a>Using polymorphic variant to model event listener</h4>
<div class="paragraph">
<p>BuckleScript model this in a type-safe way by using annotated polymorphic variants</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type readline
external on :
    (
    [ `close of unit -&gt; unit
    | `line of string -&gt; unit
    ] <b class="conum">(1)</b>
    [@bs.string])
    -&gt; readline = "" [@@bs.send.pipe: readline]
let register rl =
  rl
  |&gt; on (`close (fun event -&gt; () ))
  |&gt; on (`line (fun line -&gt; print_endline line))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is a very powerful typing: each event can have its <em>different types</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function register(rl) {
  return rl.on("close", function () {
                return /* () */0;
              })
           .on("line", function (line) {
              console.log(line);
              return /* () */0;
            });
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>These annotations will only have effect in <code>external</code> declarations.</p>
</li>
<li>
<p>The runtime encoding of using polymorphic variant is internal to the compiler.</p>
</li>
<li>
<p>With these annotations mentioned above, BuckleScript will automatically
 transform the internal encoding to the designated encoding for FFI.
 BuckleScript will try to do such conversion at compile time if it can, otherwise, it
will do such conversion in the runtime, but it should be always correct.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_phantom_arguments_and_ad_hoc_polyrmophism"><a class="anchor" href="#_phantom_arguments_and_ad_hoc_polyrmophism"></a>Phantom Arguments and ad-hoc polyrmophism</h4>
<div class="paragraph">
<p><code>bs.ignore</code> allows arguments to be erased after passing to JS functional call, the side effect will
still be recorded.</p>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external add : (int [@bs.ignore]) -&gt; int -&gt; int = ""
[@@bs.val]
let v = add 0 1 2 <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the first argument will be erased</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="javascript">var v = add (1,2)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is very useful to combine GADT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type _ kind =
  | Float : float kind
  | String : string kind
external add : ('a kind [@bs.ignore]) -&gt; 'a -&gt; 'a -&gt; 'a = "" [@@bs.val]

let () =
  Js.log (add Float 3.0 2.0);
  Js.log (add String "x" "y");</code></pre>
</div>
</div>
<div class="paragraph">
<p>User can also have a payload for the GADT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let string_of_kind (type t) (kind : t kind) =
  match kind with
  | Float -&gt; "float"
  | String -&gt; "string"

external add_dyn : ('a kind [@bs.ignore]) -&gt; string -&gt;  'a -&gt; 'a -&gt; 'a = ""
[@@bs.val]

let add2 k x y =
  add_dyn k (string_of_kind k) x y</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_binding_to_nodejs_special_variables_bs_node"><a class="anchor" href="#_binding_to_nodejs_special_variables_bs_node"></a>Binding to NodeJS special variables: bs.node</h3>
<div class="paragraph">
<p>NodeJS has several file local variables: <code><em>dirname</code>, <code></em>filename</code>, <code>module_</code>, and <code>require</code>,
their semantics are more like macros instead of functions.</p>
</div>
<div class="paragraph">
<p>BuckleScript provides built-in macro support for these variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let dirname : string Js.undefined = [%bs.node __dirname]
let filename : string Js.undefined = [%bs.node __filename]
let module_ : Node.node_module Js.undefined = [%bs.node module_]
let require : Node.node_require Js.undefined = [%bs.node require]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_binding_to_callbacks_high_order_function"><a class="anchor" href="#_binding_to_callbacks_high_order_function"></a>Binding to callbacks (high-order function)</h3>
<div class="paragraph">
<p>High order functions are functions where the callback can be another
function. For example, suppose
JS has a map function as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function map (a, b, f){
  var i = Math.min(a.length, b.length);
  var c = new Array(i);
  for(var j = 0; j &lt; i; ++j){
    c[j] = f(a[i],b[i])
  }
  return c ;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A naive external type declaration would be as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external map : 'a array -&gt; 'b array -&gt; ('a -&gt; 'b -&gt; 'c) -&gt; 'c array = "" [@@bs.val]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, this is not completely correct. The issue is by
reading the type <code>'a &#8594; 'b &#8594; 'c</code>, it can be in several cases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let f x y = x + y</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let g x  = let z  = x + 1 in fun y -&gt; x + z</code></pre>
</div>
</div>
<div class="paragraph">
<p>In OCaml, they all have the same type; however,
<code>f</code> and <code>g</code> may be compiled into functions with
different arities.</p>
</div>
<div class="paragraph">
<p>A naive compilation will compile <code>f</code> as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let f = fun x -&gt; fun y -&gt; x + y</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function f(x){
  return function (y){
    return x + y;
  }
}
function g(x){
  var z = x + 1 ;
  return function (y){
    return x + z ;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Its arity will be <em>consistent</em> but is <em>1</em> (returning another function);
however, we expect <em>its arity to be 2</em>.</p>
</div>
<div class="paragraph">
<p>Bucklescript uses a more complex compilation strategy, compiling <code>f</code> as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function f(x,y){
  return x + y ;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>No matter which strategy we use, existing typing rules <strong>cannot
guarantee a function of type <code>'a &#8594; 'b &#8594; 'c</code> will have arity 2.</strong></p>
</div>
<div class="paragraph">
<p>To solve this problem introduced by OCaml&#8217;s curried calling convention,
we support a special attribute <code>[@bs]</code> at the type level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external map : 'a array -&gt; 'b array -&gt; ('a -&gt; 'b -&gt; 'c [@bs]) -&gt; 'c array
= "map" [@@bs.val]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>('a &#8594; 'b &#8594; 'c [@bs])</code> will <em>always be of arity 2</em>, in
general,
<code>'a0 &#8594; 'a1 &#8230;&#8203; 'aN &#8594; 'b0 [@bs]</code> is the same as
<code>'a0 &#8594; 'a1 &#8230;&#8203; 'aN &#8594; 'b0</code>
except the former&#8217;s arity is guaranteed to be <code>N</code> while the latter is
unknown.</p>
</div>
<div class="paragraph">
<p>To produce a function of type <code>'a0 &#8594; .. 'aN &#8594; 'b0 [@bs]</code>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let f : 'a0 -&gt; 'a1 -&gt; .. 'b0 [@bs] =
  fun [@bs] a0 a1 .. aN -&gt; b0
let b : 'b0 = f a0 a1 a2 .. aN [@bs]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A special case for arity of 0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let f : unit -&gt; 'b0 [@bs] = fun [@bs] () -&gt; b0
let b : 'b0 = f () [@bs]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this extension to the OCaml language is <em>sound</em>. If you
add
an attribute in one place but miss it in other place, the type checker
will complain.</p>
</div>
<div class="paragraph">
<p>Another more complex example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type 'a return = int -&gt; 'a [@bs]
type 'a u0 = int -&gt; string -&gt; 'a return  [@bs] <b class="conum">(1)</b>
type 'a u1 = int -&gt; string -&gt; int -&gt; 'a [@bs] <b class="conum">(2)</b>
type 'a u2 = int -&gt; string -&gt; (int -&gt; 'a [@bs]) [@bs] <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>u0</code> has arity of 2, return a function
with arity 1</p>
</li>
<li>
<p><code>u1</code> has arity of 3</p>
</li>
<li>
<p><code>u2</code> has arity of 2, reutrn a function  with arity 1</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_uncurried_calling_convention_as_an_optimization"><a class="anchor" href="#_uncurried_calling_convention_as_an_optimization"></a>Uncurried calling convention as an optimization</h4>
<div class="paragraph">
<div class="title">Background:</div>
<p>As we discussed before, we can compile any OCaml function as arity 1
to
support OCaml&#8217;s curried calling convention.</p>
</div>
<div class="paragraph">
<p>This model is simple and easy to implement, but
the native compilation is very slow and expensive for all functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let f x y z = x + y + z
let a = f 1 2 3
let b = f 1 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be compiled as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function f(x){
  return function (y){
    return function (z){
      return x + y + z
    }
  }
}
var a = f (1) (2) (3)
var b = f (1) (2)</code></pre>
</div>
</div>
<div class="paragraph">
<p>But as you can see, this is <em>highly inefficient</em>, since the compiler
already <em>saw the source definition</em> of <code>f</code>, it can be optimized as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function f(x,y,z) {return x + y + z}
var a = f(1,2,3)
var b = function(z){return f(1,2,z)}</code></pre>
</div>
</div>
<div class="paragraph">
<p>BuckleScript does this optimization in the cross module level and tries
to infer the arity as much as it can.</p>
</div>
<div class="sect4">
<h5 id="_callback_optimization"><a class="anchor" href="#_callback_optimization"></a>Callback optimization</h5>
<div class="paragraph">
<p>However, such optimization will not work with <em>high-order</em> functions,
i.e, callbacks.</p>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let app f x = f x</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the arity of <code>f</code> is unknown, the compiler can not do any optimization
(unless <code>app</code> gets inlined), so we
have to generate code as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function app(f,x){
  return Curry._1(f,x);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Curry._1</code> is a function to dynamically support the curried calling
convention.</p>
</div>
<div class="paragraph">
<p>Since we support the uncurried calling convention, you can write <code>app</code>
as below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let app f x = f x [@bs]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the type system will infer <code>app</code> as type
<code>('a &#8594;'b [@bs]) &#8594; 'a</code> and compile <code>app</code> as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function app(f,x){
  return f(x)
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>In OCaml the compiler internally uncurries every function
declared as <code>external</code> and guarantees that it is always fully applied.
Therefore, for <code>external</code> first-order FFI, its outermost function does
not need the <code>[@bs]</code> annotation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bindings_to_code_this_code_based_callbacks_bs_this"><a class="anchor" href="#_bindings_to_code_this_code_based_callbacks_bs_this"></a>Bindings to <code>this</code> based callbacks: bs.this</h4>
<div class="paragraph">
<p>Many JS libraries have callbacks which rely on <code>this</code> (the source), for
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">x.onload = function(v){
  console.log(this.response + v )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>this</code> would be the same as <code>x</code> (actually depends on how <code>onload</code>
is called). It is clear that
it is not correct to declare <code>x.onload</code> of type <code>unit &#8594; unit [@bs]</code>.
Instead, we introduced a special attribute
<code>bs.this</code> allowing us to type <code>x</code> as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type x
external set_onload : x -&gt; (x -&gt; int -&gt; unit [@bs.this]) -&gt; unit = "onload" [@@bs.set]
external resp : x -&gt; int = "response" [@@bs.get]
set_onload x begin fun [@bs.this] o v -&gt;
  Js.log(resp o + v )
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">x.onload = function(v){
  var o = this ; <b class="conum">(1)</b>
  console.log(o.response + v);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The first argument is automatically bound to <code>this</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>bs.this</code> is the same as <code>bs</code> : except that its first parameter is
reserved for <code>this</code> and for arity of 0, there is no need for a redundant <code>unit</code> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let f : 'obj -&gt; 'b' [@bs.this] =
  fun [@bs.this] obj -&gt; ....
let f1 : 'obj -&gt; 'a0 -&gt; 'b [@bs.this] =
  fun [@bs.this] obj a -&gt; ...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>There is no way to consume a function of type
<code>'obj &#8594; 'a0 .. &#8594; 'aN &#8594; 'b0 [@bs.this]</code> on the OCaml side.
This is an intentional design choice, we <strong>don&#8217;t encourage</strong> people to write code in this style.</p>
</div>
<div class="paragraph">
<p>This was introduced mainly to be consumed by existing JS libraries.
User can also type <code>x</code> as a JS class too (see later)</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_binding_to_js_objects"><a class="anchor" href="#_binding_to_js_objects"></a>Binding to JS objects</h3>
<div class="paragraph">
<div class="title">Convention:</div>
<p>All JS objects of type <code>'a</code> are lifted to type <code>'a Js.t</code> to avoid
conflict with OCaml&#8217;s native object system (we support both OCaml&#8217;s
native object system and FFI to JS&#8217;s objects), <code>##</code> is used in JS&#8217;s
object method dispatch and field access, while <code>#</code> is used in OCaml&#8217;s
object method dispatch.</p>
</div>
<div class="paragraph">
<div class="title">Typing JavaScript objects:</div>
<p>OCaml supports object oriented style natively and provides structural type system.
OCaml&#8217;s object system has different runtime semantics from JS object, but they
share the same type system, all JS objects of type <code>'a</code> is typed as <code>'a Js.t</code></p>
</div>
<div class="paragraph">
<p>OCaml provide two kinds of syntaxes to mode structural typing: <code>&lt; p1 : t1 &gt;</code> style and
<code>class type</code> style, they are mostly the same except that the latter is more feature rich
(support inheritance) but more verbose.</p>
</div>
<div class="sect3">
<h4 id="_simple_object_type"><a class="anchor" href="#_simple_object_type"></a>Simple object type</h4>
<div class="paragraph">
<p>Suppose we have a JS file <code>demo.js</code>
which exports two properties: <code>height</code> and <code>width</code>:</p>
</div>
<div class="listingblock">
<div class="title">demo.js</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="js">exports.height = 3
exports.width  = 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are different ways to writing binding to module <code>demo</code>,
here we use OCaml objects to model module <code>demo</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external demo : &lt; height : int ; width : int &gt; Js.t = "" [@@bs.module]</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are too kinds of types on the method name:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>normal type</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">&lt; label : int &gt;
&lt; label : int -&gt; int &gt;
&lt; label : int -&gt; int [@bs]&gt;
&lt; label : int -&gt; int [@bs.this]&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>method</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">&lt; label : int -&gt; int [@bs.meth] &gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The difference is that for <code>method</code>, the type system will force users to full-fil
its arguments all at the same time, since its semantics depends on <code>this</code> in JavaScript.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let test f =
  f##hi 1 <b class="conum">(1)</b>
let test2 f   =
  let u = f##hi in
  u 1
let test3 f =
  let u = f##hi in
  u 1 [@bs]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>##</code> is JS object property/method dispatch</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The compiler would infer types differently</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val test : &lt; hi : int -&gt; 'a [@bs.meth]; .. &gt; -&gt; 'a <b class="conum">(1)</b>
val test2 : &lt; hi : int -&gt; 'a ; .. &gt; -&gt; 'a
val test3 : &lt; hi : int -&gt; 'a [@bs]; .. &gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>..</code> is a row variable, which means the object can contain more methods</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_complex_object_type"><a class="anchor" href="#_complex_object_type"></a>Complex object type</h4>
<div class="paragraph">
<p>Below is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">class type _rect = object
  method height : int
  method width : int
  method draw : unit -&gt; unit
end [@bs] <b class="conum">(1)</b>
type rect = _rect Js.t</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>class type</code> annotated with <code>[@bs]</code> is treated as a JS class type,
it needs to be lifted to <code>Js.t</code> too</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For JS classes, methods with arrow types are treated as real methods
(automatically annotated with <code>[@bs.meth]</code>)
while methods with non-arrow types
are treated as properties.</p>
</div>
<div class="paragraph">
<p>So the type <code>rect</code> is the same as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type rect = &lt; height : int ; wdith : int ; draw : unit -&gt; unit [@bs.meth] &gt; Js.t</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_to_consume_js_property_and_methods"><a class="anchor" href="#_how_to_consume_js_property_and_methods"></a>How to consume JS property and methods</h4>
<div class="paragraph">
<p>As we said:  <code>##</code> is used in both object method dispatch and field access.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">f##property <b class="conum">(1)</b>
f##property#= v
f##js_method args0 args1 args2 <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>property get should not come with any argument as we discussed above, which will be checked by the compiler</p>
</li>
<li>
<p>Here <code>method</code> is of arity 3</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>All JS method application is uncurried, JS&#8217;s <strong>method is not a function</strong>, this invariant can
be guaranteed by OCaml&#8217;s type checker, a classic example shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">console.log('fine')
var log = console.log;
log('fine') <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>May cause exception, implementation dependent, <code>console.log</code> may depend on <code>this</code></p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In BuckleScript</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let fn = f0##f in
let a = fn 1 2
(* f##field a b would think `field` as a method *)</code></pre>
</div>
</div>
<div class="paragraph">
<p>is different from</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let b = f1##f 1 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler will infer as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val f0 : &lt; f : int -&gt; int -&gt; int  &gt; Js.t
val f1 : &lt; f : int -&gt; int -&gt; int [@bs.meth] &gt; Js.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we type <code>console</code> properly in OCaml, user could only write</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">console##log "fine"
let u = console##log
let () = u "fine" <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>OCaml compiler will complain</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If a user were to make such a mistake, the type checker would
complain by saying it expected <code>Js.method</code> but saw a
function instead, so it is still sound and type safe.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_getter_setter_annotation_to_js_properties"><a class="anchor" href="#_getter_setter_annotation_to_js_properties"></a>getter/setter annotation to JS properties</h5>
<div class="paragraph">
<p>Since OCaml&#8217;s object system does not have getters/setters, we introduced two
attributes <code>bs.get</code> and <code>bs.set</code> to help inform BuckleScript to compile
them as property getters/setters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type y  = &lt;
 height : int [@@bs.set {no_get}] <b class="conum">(1)</b>
&gt; Js.t
type y0 = &lt;
 height : int [@@bs.set] [@@bs.get {null}] <b class="conum">(2)</b>
&gt; Js.t
type y1 = &lt;
  height : int [@@bs.set] [@@bs.get {undefined}] <b class="conum">(3)</b>
&gt; Js.t
type y2 = &lt;
  height : int [@@bs.set] [@@bs.get {undefined; null}] <b class="conum">(4)</b>
&gt; Js.t
type y3 = &lt;
  height : int  [@@bs.get {undefined ; null}] <b class="conum">(5)</b>
&gt; Js.t</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>height</code> is setter only</p>
</li>
<li>
<p>getter return <code>int Js.null</code></p>
</li>
<li>
<p>getter return <code>int Js.undefined</code></p>
</li>
<li>
<p>getter return <code>int Js.null_undefined</code></p>
</li>
<li>
<p>getter only, return <code>int Js.null_undefined</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Getter/Setter also applies to class type label
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_js_objects_using_bs_obj"><a class="anchor" href="#_create_js_objects_using_bs_obj"></a>Create JS objects using bs.obj</h4>
<div class="paragraph">
<p>Not only can we create bindings to JS objects, but also we can
create JS objects in a type safe way in OCaml side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let u = [%bs.obj { x = { y = { z = 3}}} ] <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>bs.obj</code> extension is used to mark <code>{}</code> as JS objects</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var u = { x : { y : { z : 3 }}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler would infer <code>u</code> as type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val u : &lt; x :  &lt; y : &lt; z : int &gt; Js.t &gt;  Js.t &gt; Js.t</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it more symmetric,  extension <code>bs.obj</code> can also be applied
into the type level, so you can write</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val u : [%bs.obj: &lt; x : &lt; y &lt; z : int &gt; &gt; &gt; ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Users can also write expression and types together as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let u = [%bs.obj ( { x = { y = { z = 3 }}} : &lt; x : &lt; y : &lt; z : int &gt; &gt; &gt; ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Objects in a collection also works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let xs = [%bs.obj [| { x = 3 } ; {x = 3 } |] : &lt; x : int  &gt; array  ]
let ys = [%bs.obj [| { x = 3} : { x = 4 } |] ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var xs = [ { x : 3 } , { x : 3 }]
var ys = [ { x : 3 },  {x : 4 } ]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_js_objects_using_external"><a class="anchor" href="#_create_js_objects_using_external"></a>Create JS objects using external</h4>
<div class="paragraph">
<p><code>bs.obj</code> can also be used as an attribute in external declarations, as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external make_config : hi:int -&gt; lo:int -&gt; unit -&gt; t = "" [@@bs.obj]
let v = make_config ~hi:2 ~lo:3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var v = { hi:2, lo:3}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Option argument is also supported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external make_config : hi:int -&gt; ?lo:int -&gt; unit -&gt; t = "" [@@bs.obj] <b class="conum">(1)</b>
let u = make_config ~hi:3 ()
let v = make_config ~lo:2 ~hi:3  ()</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>In OCaml, the order of label does not matter, and the evaluation order
of arguments is undefined. Since the order does not matter, to make sure the compiler realize all the arguments
are full-filled (including optional arguments), it is common to have a <code>unit</code> type before the result</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var u = {hi : 3}
var v = {hi : 3 , lo: 2}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we can write JS style code in OCaml too (in a type safe way):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let u = [%bs.obj {
  x = { y = { z = 3 } };
  fn = fun [@bs] u v -&gt; u + v <b class="conum">(1)</b>
  } ]
let h = u##x##y##z
let a = h##fn
let b = a 1 2 [@bs]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>fn</code> property is not method, it does not rely on <code>this</code>,
we will show how to create JS method in OCaml later.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var u = { x : { y : {z : 3}}, fn : function (u,v) {return u + v}}
var h = u.x.y.z
var a = h.fn
var b = a(1,2)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>When the field is an uncurried function, a short-hand syntax <code>#@</code>
is available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let b x y h = h#@fn x y</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function b (x,y,h){
  return h.fn(x,y)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler will infer the type of <code>b</code> as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val b : 'a -&gt; 'b -&gt;  &lt; fn :  'a -&gt; 'b -&gt; 'c [@bs] &gt; Js.t -&gt; 'c</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_create_js_objects_with_code_this_code_semantics"><a class="anchor" href="#_create_js_objects_with_code_this_code_semantics"></a>Create JS objects with <code>this</code> semantics</h4>
<div class="paragraph">
<p>The objects created above can not use <code>this</code> in the method, this is supported in
BuckleScript too.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let v2  =
  let x = 3. in
  object (self) <b class="conum">(1)</b>
    method hi x  y = self##say x +. y
    method say x =  x *. self## x ()
    method x () = x
  end [@bs] <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>self</code> is bound to <code>this</code> in generated JS code</p>
</li>
<li>
<p><code>[@bs]</code> marks <code>object .. end</code> as a JS object</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var v2 = {
  hi: function (x, y) {
    var self = this ;
    return self.say(x) + y;
  },
  say: function (x) {
    var self = this ;
    return x * self.x();
  },
  x: function () {
    return 3;
  }
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compiler  infer the type of <code>v2</code> as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val v2 : object
  method hi : float -&gt; float -&gt; float
  method say : float -&gt; float
  method x : unit -&gt; float
end [@bs]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is another example to consume JS object :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let f (u : rect) =
  (* the type annotation is un-necessary,
     but it gives better error message
  *)
   Js.log u##height ;
   Js.log u##width ;
   u##width #= 30;
   u##height #= 30;
   u##draw ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">function f(u){
  console.log(u.height);
  console.log(u.width);
  u.width = 30;
  u.height = 30;
  return u.draw()
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_method_chaining"><a class="anchor" href="#_method_chaining"></a>Method chaining</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">f
##(meth0 ())
##(meth1 a)
##(meth2 a b)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_embedding_raw_javascript_code"><a class="anchor" href="#_embedding_raw_javascript_code"></a>Embedding raw Javascript code</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>This is not encouraged. The user should minimize and
localize use cases
of embedding raw Javascript code, however, sometimes it&#8217;s necessary to
get the job done.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_embedding_raw_js_code_as_an_expression"><a class="anchor" href="#_embedding_raw_js_code_as_an_expression"></a>Embedding raw JS code as an expression</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let keys : t -&gt; string array [@bs] = [%bs.raw "Object.keys" ]
let unsafe_lt : 'a -&gt; 'a -&gt; Js.boolean [@bs] = [%bs.raw{|function(x,y){return x &lt; y}|}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We highly recommend writing type annotations for such unsafe code. It is unsafe
to
refer to external OCaml symbols in raw JS code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_embedding_raw_js_code_as_statements"><a class="anchor" href="#_embedding_raw_js_code_as_statements"></a>Embedding raw JS code as statements</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">[%%bs.raw{|
  console.log ("hey");
|}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let x  : string = [%bs.raw{|"\x01\x02"|}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will be compiled into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var x = "\x01\x02"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Polyfill of <code>Math.imul</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">   [%%bs.raw{|
   // Math.imul polyfill
   if (!Math.imul){
       Math.imul = function (..) {..}
    }
   |}]</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>So far we don&#8217;t perform any sanity checks in the quoted text (syntax
checking is a long-term goal).</p>
</li>
<li>
<p>Users should not refer to symbols in OCaml code. It is not guaranteed
that the order is correct.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugger_support"><a class="anchor" href="#_debugger_support"></a>Debugger support</h3>
<div class="paragraph">
<p>We introduced the extension <code>bs.debugger</code>, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">  let f x y =
    [%bs.debugger];
    x + y</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will be compiled into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">  function f (x,y) {
     debugger; // JavaScript developer tools will set an breakpoint and stop here
     x + y;
  }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_regex_support"><a class="anchor" href="#_regex_support"></a>Regex support</h3>
<div class="paragraph">
<p>We introduced <code>bs.re</code> for Javascript regex expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let f  = [%bs.re "/b/g"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler will infer <code>f</code> has type <code>Js.Re.t</code> and generate code as
below</p>
</div>
<div class="listingblock">
<div class="content">
<pre>var f = /b/g</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>Js.Re.t</code> is an abstract type, we are working on providing
bindings for it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_examples_2"><a class="anchor" href="#_examples_2"></a>Examples</h3>
<div class="paragraph">
<p>Below is a simple example for <a href="https://mochajs.org/">mocha</a> library. For
more examples, please visit
<a href="https://github.com/bloomberg/bucklescript-addons" class="bare">https://github.com/bloomberg/bucklescript-addons</a></p>
</div>
<div class="sect3">
<h4 id="_a_simple_example_binding_to_mocha_unit_test_library"><a class="anchor" href="#_a_simple_example_binding_to_mocha_unit_test_library"></a>A simple example: binding to mocha unit test library</h4>
<div class="paragraph">
<p>This is an example showing how to provide bindings to the
<a href="https://mochajs.org/">mochajs</a> unit test framework.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external describe : string -&gt; (unit -&gt; unit [@bs]) -&gt; unit = "" [@@bs.val]
external it : string -&gt; (unit -&gt; unit [@bs]) -&gt; unit = "" [@@bs.val]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since, <code>mochajs</code> is a test framework, we also need some assertion
 tests. We can also describe the bindings to <code>assert.deepEqual</code> from
 nodejs <code>assert</code> library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">external eq : 'a -&gt; 'a -&gt; unit = "deepEqual"  [@@bs.module "assert"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>On top of this we can write normal OCaml functions, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let assert_equal = eq
let from_suites name suite  =
    describe name (fun [@bs] () -&gt;
         List.iter (fun (name, code) -&gt; it name code) suite
         )</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler would generate code as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"> var Assert = require("assert");
 var List = require("bs-platform/lib/js/list");

function assert_equal(prim, prim$1) {
 return Assert.deepEqual(prim, prim$1);
 }

function from_suites(name, suite) {
 return describe(name, function () {
   return List.iter(function (param) {
    return it(param[0], param[1]);
      }, suite);
  });
 }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_js_module"><a class="anchor" href="#_js_module"></a>Js module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Js module is shipped with BuckleScript, both the namespace <code>Js</code> and <code>Node</code> are preserved.</p>
</div>
<div class="listingblock">
<div class="title">Js Public types</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Js Nested modules</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>Null</code>, <code>Undefined</code> and <code>Null_undefined</code> have similar interfaces, for example:</p>
</div>
<div class="listingblock">
<div class="title">Js.Null module</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Js Utility functions</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Js Predefined JS values</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml"></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extended_compiler_options"><a class="anchor" href="#_extended_compiler_options"></a>Extended compiler options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BuckleScript inherits the command line arguments of the
<a href="http://caml.inria.fr/pub/docs/manual-ocaml/comp.html">OCaml compiler</a>. It
also adds several flags:</p>
</div>
<div class="sect2">
<h3 id="__bs_main_single_directory_build"><a class="anchor" href="#__bs_main_single_directory_build"></a>-bs-main (single directory build)</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -bs-main main.ml</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bsc</code> will build module <code>Main</code> and all its dependencies, when it
finishes, it will run <code>node main.js</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -c -bs-main main.ml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same as above, but will not run <code>node</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="__bs_files"><a class="anchor" href="#__bs_files"></a>-bs-files</h3>
<div class="paragraph">
<p>So that you can do</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">bsc -c -bs-files *.ml *.mli</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler will sort the order of input files before starting
compilation.</p>
</div>
<div class="paragraph">
<p>BuckleScript supports two compilation mode, script mode and package
mode, in package mode, you have to provide <code>package.json</code> on top and set the options
<code>-bs-package-name</code>, <code>-bs-package-output</code>. In script mode, such flags are not needed</p>
</div>
</div>
<div class="sect2">
<h3 id="__bs_package_name"><a class="anchor" href="#__bs_package_name"></a>-bs-package-name</h3>
<div class="paragraph">
<p>The project name of your project, user is suggested to make it
consistent with the <code>name</code> field in <code>package.json</code></p>
</div>
</div>
<div class="sect2">
<h3 id="__bs_packge_output"><a class="anchor" href="#__bs_packge_output"></a>-bs-packge-output</h3>
<div class="paragraph">
<p>The format is <code>module_system:oupt/path/relative/to/package.json</code>
Currently supported module systesms are: <code>commonjs</code>, <code>amdjs</code> and
<code>goog:&lt;namespace&gt;</code></p>
</div>
<div class="paragraph">
<p>For example, when you want to use the <code>goog</code> module system, you can do
things like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">bsc -bs-package-name your_package -bs-package-output goog:lib/goog -c xx.ml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
User can supply multiple <code>-bs-package-output</code> at the same time.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">bsc -bs-package-name name -bs-package-output commonjs:lib/js -bs-package-output goog:lib/goog -bs-package-output amdjs:lib/amdjs -c x.ml</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will generate <code>x.js</code> in <code>lib/js</code> as commonjs module, <code>lib/goog</code> as google module and <code>lib/amdjs</code> as amdjs module at the same time.</p>
</div>
<div class="paragraph">
<p>You would then need a bundler for the different module systems:
<code>webpack</code> supports <code>commonjs</code> and <code>amdjs</code> while
<code>google closure compiler</code> supports all.</p>
</div>
</div>
<div class="sect2">
<h3 id="__bs_gen_tds"><a class="anchor" href="#__bs_gen_tds"></a>-bs-gen-tds</h3>
<div class="paragraph">
<p>Trigger the generation of TypeScript <code>.d.ts</code> files.
<code>bsc</code> has the ability to also emits <code>.d.ts</code> for better interaction with
typescript. This is still experimental.</p>
</div>
<div class="paragraph">
<p>For more options, please see the documentation of <code>bsc -help</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="__bs_no_builtin_ppx_ml_bs_no_builtin_ppx_mli"><a class="anchor" href="#__bs_no_builtin_ppx_ml_bs_no_builtin_ppx_mli"></a>-bs-no-builtin-ppx-ml, -bs-no-builtin-ppx-mli</h3>
<div class="paragraph">
<p>If users don&#8217;t use any bs specific annotaions, user can explicitly turn it off.
Another use case is that users can use <code>-ppx</code> explicitly as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">bsc -c -ppx bsppx -bs-no-builtin-ppx-ml c.ml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_semantics_difference_from_other_backends"><a class="anchor" href="#_semantics_difference_from_other_backends"></a>Semantics difference from other backends</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is particularly important when porting an existing OCaml
application to JavaScript.</p>
</div>
<div class="sect2">
<h3 id="_custom_data_type"><a class="anchor" href="#_custom_data_type"></a>Custom data type</h3>
<div class="paragraph">
<p>In OCaml, the C FFI allows the user to define a custom data type and
customize <code>caml_compare</code>, <code>caml_hash</code> behavior, etc. This is not
available in our backend (since we have no C FFI).</p>
</div>
</div>
<div class="sect2">
<h3 id="_physical_in_equality"><a class="anchor" href="#_physical_in_equality"></a>Physical (in)equality</h3>
<div class="paragraph">
<p>In general, Users should only use physical equality as an optimization
technique, but not rely on its correctness, since it is tightly coupled
with the runtime.</p>
</div>
</div>
<div class="sect2">
<h3 id="_string_char_range"><a class="anchor" href="#_string_char_range"></a>String char range</h3>
<div class="paragraph">
<p>Currently, BuckleScript assumes that the char range is <code>0-255</code>. The user
should be careful when they pass a JavaScript string to OCaml side. Note
that we are working on a solution for this problem.</p>
</div>
</div>
<div class="sect2">
<h3 id="_weak_map"><a class="anchor" href="#_weak_map"></a>Weak map</h3>
<div class="paragraph">
<p>OCaml&#8217;s weak map is not available in BuckleScript. The weak pointer is
replaced by a strict pointer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_integers"><a class="anchor" href="#_integers"></a>Integers</h3>
<div class="paragraph">
<p>OCaml has <code>int</code>, <code>int32</code>, <code>nativeint</code> and <code>int64</code> types.
- Both <code>int32</code> and <code>int64</code> in BuckleScript have the exact same semantics as OCaml.
- <code>int</code> in BuckleScript is the same as <code>int32</code> while in OCaml it&#8217;s platform dependent.
- <code>nativeint</code> is treated as JavaScript float, except for division.
  For example, <code>Nativeint.div a b</code> will be translated into <code>a /b | 0</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p><code>Nativeint.shift_right_logical x 0</code> is different from
<code>Int32.shift_right_local x 0</code>. The former is literally translated into
<code>x &gt;&gt;&gt; 0</code> (translated into an unsigned int), while the latter is
<code>x | 0</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_printf_printf"><a class="anchor" href="#_printf_printf"></a>Printf.printf</h3>
<div class="paragraph">
<p>The <code>Printf.print</code> implementation in BuckleScript requires a newline
(<code>\n</code>) to trigger the printing. This behavior is not consistent with the
buffered behavior of native OCaml. The only potential problem we foresee
is that if the program terminates with no newline character, the text
will never be printed.
<mark>#</mark> Obj module</p>
</div>
<div class="paragraph">
<p>We do our best to mimic the native compiler, but we have no guarantee
and there are differences.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hashtbl_hash_algorithm"><a class="anchor" href="#_hashtbl_hash_algorithm"></a>Hashtbl hash algorithm</h3>
<div class="paragraph">
<p>BuckleScript uses the same algorithm as native OCaml but the output is
different due to runtime representation of int/int64/int32 and float.</p>
</div>
</div>
<div class="sect2">
<h3 id="_marshall"><a class="anchor" href="#_marshall"></a>Marshall</h3>
<div class="paragraph">
<p>Marshall module is not supported yet.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sys_argv"><a class="anchor" href="#_sys_argv"></a>Sys.argv</h3>
<div class="paragraph">
<p>Command line arguments are always empty,
will be fixed in the near future.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unsupported_io_primitives"><a class="anchor" href="#_unsupported_io_primitives"></a>Unsupported IO primitives</h3>
<div class="paragraph">
<p>Because of the JavaScript environment limitation, <code>Pervasives.stdin</code> is
not supported but both <code>Pervasives.stdout</code> and <code>Pervasives.stderr</code> are.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_faq"><a class="anchor" href="#_faq"></a>FAQ</h2>
<div class="sectionbody">
<div class="qlist qanda">
<ol>
<li>
<p><em>How to adapt your build system?</em></p>
<p>The BuckleScript compilation model is the same as the OCaml compiler.
If <code>b.ml</code> depends on <code>a.ml</code>, you have to compile <code>a.ml</code> <strong>and</strong> <code>a.mli</code>
first.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The technical reason is that BuckleScript will generate intermediate
files with the extension <code>.cmj</code> which are later used for cross module
inlining, arity inference and other information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a simple Makefile to get started:</p>
</div>
<div class="listingblock">
<div class="title">Makefile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="make">OCAMLC=bsc <b class="conum">(1)</b>
OCAMLDEP=ocamldep <b class="conum">(2)</b>
SOURCE_LIST := src_a src_b
SOURCE_MLI  = $(addsuffix .mli, $(SOURCE_LIST))
SOURCE_ML   = $(addsuffix .ml, $(SOURCE_LIST))
TARGETS := $(addsuffix .cmj, $(SOURCE_LIST))
INCLUDES=
all: $(TARGETS)
%.cmi: %.mli
        $(OCAMLC) $(INCLUDES) $(COMPFLAGS)  -c $&lt;
%.ml: %.cmj:
        $(OCAMLC) $(INCLUDES) $(COMPFLAGS)  -c $&lt;
-include .depend
depend:
        $(OCAMLDEP) $(INCLUDES) $(SOURCE_ML) $(SOURCE_MLI) | sed -e 's/\.cmx/.cmj/g' &gt; .depend</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>bsc is the BuckleScript compiler</p>
</li>
<li>
<p>ocamldep executable is part of the OCaml compiler installation</p>
</li>
</ol>
</div>
</li>
<li>
<p><em>How does IO work in browser?</em></p>
<p>In general, it is very hard to simulate IO in browser, we recommend users to write bindings to NodeJS directly for server side, or use <code>Js.log</code> in client side, see disucssions in <a href="https://github.com/bloomberg/bucklescript/issues/748">#748</a></p>
</li>
<li>
<p><em>The compiler does not build?</em></p>
<p>  In production mode, the compiler is a single file in
<code>jscomp/bin/compiler.ml</code>. If it is not compiling, make sure you have the
right OCaml compiler version. Currently the OCaml compiler is a
submodule of BuckleScript. Make sure the exact commit hash matches (we
only update the compiler occasionally).</p>
</li>
<li>
<p><em>Which version of JavaScript syntax does BuckleScript target?</em></p>
<p>BuckleScript targets <strong>ES5</strong>.</p>
</li>
<li>
<p><em>What polyfills does BuckleScript need?</em></p>
<div class="ulist">
<ul>
<li>
<p><em>Math.imul</em>:
This polyfill is needed for <code>int32</code> multiplication.
BuckleScript provides this by default(when feature detection returns false), no action is
required from the user.</p>
</li>
<li>
<p><em>TypedArray</em>:
The TypedArray polyfill is not provided by BuckleScript and it&#8217;s the
responsibility of the user to bundle the desired polyfill implementation
with the BuckleScript generated code.</p>
<div class="literalblock">
<div class="content">
<pre>The following functions from OCaml stdlib
require the TypedArray polyfill:</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Int64.float_of_bits</p>
</li>
<li>
<p>Int64.bits_of_float</p>
</li>
<li>
<p>Int32.float_of_bits</p>
</li>
<li>
<p>Int32.bits_of_float</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>For the current BuckleScript version, if the user does not bundle the
TypedArray polyfill, the JavaScript engine does not support it and user used
functions mentioned above, the code will fail at runtime.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_high_level_compiler_workflow"><a class="anchor" href="#_high_level_compiler_workflow"></a>High Level compiler workflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The high level architecture is illustrated below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Source Language
  |
  | (Reuse OCaml Parser)
  v
Surface Syntax Tree
  |
  | (built in Syntax tree transformation)
  v
Surface Syntax Tree
  |
  | (Reuse OCaml Type checker)
  v
Typedtree
  |
  | (Reuse OCaml pattern match compiler and erase types)
  |
  |
OCaml Lambda IR
  |
  |
  v
Buckle Lambda IR ------------------+
  |   ^                            |
  |   |                     Lambda Passes (lam_* files)
  |   |             Optimization/inlining/dead code elimination
  |   \                            |
  |    \ --------------------------+
  |
  |  Self tail call elimination
  |  Constant folding + propagation
  V
JS IR (J.ml)  ---------------------+
  |   ^                            |
  |   |                     JS Passes (js_* files)
  |   |            Optimization/inlining/dead code elimination
  |   \                            |
  |    \  -------------------------+
  |
  |  Smart printer includes scope analysis
  |
  V
Javascript Code</pre>
</div>
</div>
<div class="sect2">
<h3 id="_design_principles"><a class="anchor" href="#_design_principles"></a>Design Principles</h3>
<div class="paragraph">
<p>The current design of BuckleScript follows several high level
principles. While those principles might change in the future, there are
enforced today and can explain certain technical limitations
BuckleScript has.</p>
</div>
<div class="paragraph">
<p><strong>Lambda Representation</strong></p>
</div>
<div class="paragraph">
<p>As pictured in the diagram above, BuckleScript is primarily based on the
Lambda representation of the OCaml compiler. While this representation
is quite rich, some information is lost from the upstream
representation. The patch to the OCaml compiler tries to enrich this
representation in a non-intrusive way (see next section).</p>
</div>
<div class="paragraph">
<p><strong>Minimal Patch to the OCaml compiler</strong></p>
</div>
<div class="paragraph">
<p>BuckleScript requires patches to the OCaml compiler. One of the main
reasons is to enrich the Lambda representation so that the generated
code is as nice as possible. A design goal is to keep those patches
minimal and useful for the OCaml compiler in general so that they can
later be integrated.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>A common question is to wonder why BuckleScript transpiles an OCaml
record value to a JavaScript array while a more intuitive representation
would be a JavaScript object. This technical decision is a direct
consequence of the above 2 design principles: the Lambda layer assumes
in a lot of places that a record value is an array and such modification
would be too large of a change to OCaml compiler.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_soundness"><a class="anchor" href="#_soundness"></a>Soundness</h3>
<div class="paragraph">
<p>BuckleScript preserves the soundness of the OCaml language. Assuming the
FFI is correctly implemented, the type safety is preserved.</p>
</div>
</div>
<div class="sect2">
<h3 id="_minimal_new_symbol_creation"><a class="anchor" href="#_minimal_new_symbol_creation"></a>Minimal new symbol creation</h3>
<div class="paragraph">
<p>In order to make the JavaScript generated code as close as possible to
the original OCaml core we thrive to introduce as few new symbols as
possible.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_runtime_representation"><a class="anchor" href="#_runtime_representation"></a>Runtime representation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below is a description of how OCaml values are encoded in JavaScript,
the <strong>internal</strong> description means <strong>users should not rely on its actual
encoding (and it is subject to change)</strong>. We recommend that you write
setter/getter functions to manipulate safely OCaml values from JavaScript.</p>
</div>
<div class="paragraph">
<p>For example, users should not rely on how OCaml <code>list</code> is encoded in
JavaScript; instead, the OCaml stdlib provides three functions: <code>List.cons</code>, <code>List.hd</code> and
<code>List.tl</code>. JavaScript code should only rely on those three functions.</p>
</div>
<div class="sect2">
<h3 id="_simple_ocaml_type"><a class="anchor" href="#_simple_ocaml_type"></a>Simple OCaml type</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ocaml type</th>
<th class="tableblock halign-left valign-top">JavaScrit type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nativeint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">int32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">float</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bool</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>number</p>
</div>
<div class="ulist">
<ul>
<li>
<p>true &#8594; 1</p>
</li>
<li>
<p>false &#8594; 0</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of size two numbers <code>[hi,lo]</code>. <code>hi</code> is signed while <code>lo</code> is unsigned</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">char</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>number</p>
</div>
<div class="paragraph">
<p>for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'a' &#8594; <code>97</code></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bytes</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>number array</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We might encode it as buffer  in NodeJS.
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">'a array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">record</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Array <strong>internal</strong></p>
</div>
<div class="paragraph">
<p>For instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type t = { x : int; y : int }
let v = {x = 1;  y = 2}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js">var v = [1,2]</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tuple</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>Array</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(3,4) &#8594; [3,4]</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8217;a option</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>internal</strong></p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>None</code> &#8594; <code>0</code></p>
</li>
<li>
<p><code>Some a</code> &#8594; <code>[a]</code></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">list</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>internal</strong></p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>[]</code> &#8594; <code>0</code></p>
</li>
<li>
<p><code>x::y</code> &#8594; <code>[x,y]</code></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>internal</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Polymorphic variant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>internal</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">exception</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>internal</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extension</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>internal</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>internal</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Js.boolean</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>boolean</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Js.true_ &#8594; true</p>
</li>
<li>
<p>Js.false_ &#8594; false</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Js module</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val Js.to_bool: Js.boolean -&gt; bool</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'a Js.Null.t</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>either <code>'a</code> or <code>null</code></p>
</div>
<div class="listingblock">
<div class="title">Js.Null module</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val to_opt : 'a t -&gt; 'a option

val return : 'a -&gt; 'a t

val test : 'a t -&gt; bool</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'a Js.Undefined.t</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>either <code>'a</code> or <code>undefined</code></p>
</div>
<div class="listingblock">
<div class="title">Js.Undefined</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val to_opt : 'a t -&gt; 'a option
val return : 'a -&gt; 'a t
val test : 'a t -&gt; bool</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'a Js.Null_undefined.t</code></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>either <code>'a</code>, <code>null</code> or <code>undef</code></p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>Js.to_opt</code> is optimized when the <code>option</code> is not escaped
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In the future, we will have a <em>debug</em> mode, in which the
corresponding js encoding will be instrumented with more information
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As we clarified before, the internal representation should not be relied
upon.
We are working to provide a ppx extension as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">type t =
  | A
  | B of int * int
  | C of int * int
  | D [@@bs.deriving{export}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>So that it will a automatically provide <code>constructing</code> and
<code>destructing</code> functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">val a : t
val b : int -&gt; int -&gt; t
val c : int -&gt; int -&gt; t
val d : int

val a_of_t : t -&gt; bool
val d_of_t : t -&gt; bool
val b_of_t : t -&gt; (int * int ) Js.Null.t
val c_of_t : t -&gt; (int * int ) Js.Null.t</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integration_with_reason"><a class="anchor" href="#_integration_with_reason"></a>Integration with Reason</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can play with Reason using the playground
<a href="https:////bloomberg.github.io/bucklescript/reason-demo">Facebook Reason</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">The playgrounds are only for demos and might not be the latest</div>
<div class="paragraph">
<p>You should always use the command line as your production tool.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is a stand alone example <a href="https://github.com/bloomberg/bucklescript-addons/blob/master/examples/reason-demo/package.json">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_contribute"><a class="anchor" href="#_how_to_contribute"></a>How to contribute</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_build_the_compiler"><a class="anchor" href="#_build_the_compiler"></a>Build the compiler</h3>
<div class="paragraph">
<p>The development of BuckleScript compiler relies on 2 tools which are
readily available in <code>opam</code> and work with our patched OCaml compiler:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://caml.inria.fr/pub/docs/manual-ocaml-400/manual032.html">ocamlbuild</a>:
Default build tool for OCaml project</p>
</li>
<li>
<p><a href="https://github.com/ocaml/camlp4">camlp4</a>: Tool used to generate OCaml
code for processing large AST. (j.ml file).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After having installed the above dependencies from opam you can run the
following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">cd jscomp/
./build.sh</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_the_runtime"><a class="anchor" href="#_build_the_runtime"></a>Build the runtime</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">cd ./runtime; make all</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_the_stdlib"><a class="anchor" href="#_build_the_stdlib"></a>Build the stdlib</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">cd ./stdlib; make all</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_help_rewrite_the_whole_runtime_in_ocaml"><a class="anchor" href="#_help_rewrite_the_whole_runtime_in_ocaml"></a>Help rewrite the whole runtime in OCaml</h3>
<div class="paragraph">
<p>BuckleScript runtime implementation is currently a mix of OCaml and
JavaScript. (<code>jscomp/runtime</code> directory). The JavaScript code is defined
in the <code>.ml</code> file using the <code>bs.raw</code> syntax extension.</p>
</div>
<div class="paragraph">
<p>The goal is to implement the runtime <strong>purely in OCaml</strong> and you can help
contribute.</p>
</div>
<div class="paragraph">
<p>Each new PR should include appropriate testing.</p>
</div>
<div class="paragraph">
<p>Currently all tests are in <code>jscomp/test</code> directory and you should either
add a new test file or modify an existing test which covers the part of
the compiler you modified.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the filename in <code>jscomp/test/test.mllib</code></p>
</li>
<li>
<p>Add a suite test</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The specification is in <code>jscomp/test/mt.ml</code></p>
</div>
<div class="paragraph">
<p>For example some simple tests would be like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ocaml">let suites : _ Mt.pair_suites =
   ["hey", (fun _ -&gt; Eq(true, 3 &gt; 2));
       "hi", (fun _ -&gt;  Neq(2,3));
       "hello", (fun _ -&gt; Approx(3.0, 3.0));
       "throw", (fun _ -&gt; ThrowAny(fun _ -&gt; raise 3))
       ]
let () = Mt.from_pair_suites __FILE__ suites</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the tests</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Suppose you have mocha installed, if not, try <code>npm install mocha</code></p>
</div>
<div class="paragraph">
<p><code>mocha -R list jscomp/test/your_test_file.js</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>See the coverage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>npm run cover</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comparisons"><a class="anchor" href="#_comparisons"></a>Comparisons</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_difference_from_a_href_https_github_com_ocsigen_js_of_ocaml_js_of_ocaml_a"><a class="anchor" href="#_difference_from_a_href_https_github_com_ocsigen_js_of_ocaml_js_of_ocaml_a"></a>Difference from <a href="https://github.com/ocsigen/js_of_ocaml">js_of_ocaml</a></h3>
<div class="paragraph">
<p>Js_of_ocaml is a popular compiler which compiles OCaml&#8217;s bytecode into JavaScript. It is the
inspiration for this project, and has already been under development for
several years and is ready for production. In comparison, BuckleScript,
while moving fast, is still a very young project. BuckleScript&#8217;s
motivation, like <code>js_of_ocaml</code>, is to unify the ubiquity of the
JavaScript platform and the truly sophisticated type system of OCaml,
however, there are some areas where we view things differently from
<code>js_of_ocaml</code>. We describe below, some of these differences, and also
refer readers to some of the original informal
<a href="https://github.com/ocsigen/js_of_ocaml/issues/338">discussions</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Js_of_ocaml takes lowlevel bytecode from OCaml compiler, BuckleScript
takes the highlevel rawlambda representation from OCaml compiler</p>
</li>
<li>
<p>Js_of_ocaml focuses more on existing OCaml eco-system(opam) while
BuckleScript&#8217;s major goal is to target npm</p>
</li>
<li>
<p>Js_of_ocaml and BuckleScript have slightly different runtime encoding
in several places, for example, BuckleScript encodes OCaml Array as JS
Array while js_of_ocaml requires its index 0 to be of value 0.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both projects are improving quickly, so this can change in the future!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_changes"><a class="anchor" href="#_changes"></a>Appendix A: CHANGES</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_1_02_dev"><a class="anchor" href="#_1_02_dev"></a>1.02 (dev)</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Bug fixes and enhancement</p>
<div class="ulist">
<ul>
<li>
<p>Fix Bytes.blit when src==dst <a href="https://github.com/bloomberg/bucklescript/issues743">#743</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_01"><a class="anchor" href="#_1_01"></a>1.01</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>FFI</p>
<div class="ulist">
<ul>
<li>
<p>support fields and mutable fields in JS object creation
and private method <a href="https://github.com/bloomberg/bucklescript/issues/694">#694</a></p>
</li>
<li>
<p>Introduce phantom arguments (<code>bs.ignore</code>) for ad-hoc
polymorphism <a href="https://github.com/bloomberg/bucklescript/issues/686">#686</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Bug fixes and enhancement</p>
<div class="ulist">
<ul>
<li>
<p>Enforce <code>#=</code> always return unit <a href="https://github.com/bloomberg/bucklescript/issues718">#718</a> for better error messages</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_0"><a class="anchor" href="#_1_0"></a>1.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Initial release</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
</div>
</div>
</body>
</html>